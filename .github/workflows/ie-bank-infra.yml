name: app-infra-adnan #UPDATE TO YOUR USER ALIAS

on:
  workflow_dispatch:
  push:
    paths:
      - "infra/**"
      - ".github/workflows/ie-bank-infra.yml"

env:
  RESOURCE_GROUP_DEV: aguadamillas_students_2
  SUBSCRIPTION_ID_DEV: e0b9cada-61bc-4b5a-bd7a-52c606726b3b
  USER_ALIAS: adnan

# ok here we also have two jobs build-deply, and we write checkout code, and run bicep linter for main.bicep
# then we deploy and i added env vars so pass in the params. and for steps we first checkout code, login, and deploy with the
# params that we pass in, and my user alias.

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      # Exercise II
      # GitHub action: Write step to checkout code

      - uses: actions/checkout@main

      # Exercise II
      # GitHub action: Write step to linter main.bicep

      - name: Run Bicep linter
        run: az bicep build --file ./infra/main.bicep

  deploy:
    runs-on: ubuntu-latest
    needs: build
    environment:
      name: "Development"
    env:
      # here we are setting env vars as we want to use them below when passing params. it's normally safer to do this with github secrets or github env vars, but as we
      # are on a shared repo, just chose to do it this way. got the job done.
      ENV: dev
      DBHOST: adnan-dbsrv-dev.postgres.database.azure.com
      DBNAME: adnan-db-dev
      FLASK_APP: app.py
      FLASK_DEBUG: 1

    steps:
      # Exercise II
      # GitHub action: Write step to checkout code
      - uses: actions/checkout@main

      # Exercise II
      # GitHub action: Write step to login in to Azure. You can use the repository secret AZURE_CREDENTIALS
      - uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # Exercise II
      # GitHub action: Write step to deploy main.bicep file to Azure. You can use the repository secrets DBPASS and DBUSER.
      # Recommended to use your student alias to set the deployment name to avoid conflicts with other student's deployments
      - name: deploy
        uses: azure/arm-deploy@v1
        with:
          subscriptionId: ${{ env.SUBSCRIPTION_ID_DEV }}
          resourceGroupName: ${{ env.RESOURCE_GROUP_DEV }}
          template: ./infra/main.bicep
          parameters: ./infra/parameters/dev.parameters.json appServiceAPIEnvVarENV=${{ env.ENV }} appServiceAPIEnvVarDBHOST=${{ env.DBHOST }} appServiceAPIEnvVarDBNAME=${{ env.DBNAME }} appServiceAPIEnvVarDBPASS=${{ secrets.DBPASS }} appServiceAPIDBHostDBUSER=${{ secrets.DBUSER }} appServiceAPIDBHostFLASK_APP=${{ env.FLASK_APP }} appServiceAPIDBHostFLASK_DEBUG=${{ env.FLASK_DEBUG }}
          deploymentName: ${{ env.USER_ALIAS }}
